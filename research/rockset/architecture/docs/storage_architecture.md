# Rockset 存储架构

## 基本概述

Rockset 使用 RocksDB 作为其存储引擎，这是一个开源的键值存储系统，广泛应用于需要高性能和低延迟访问的存储系统中。RocksDB 已成为许多数据库管理系统的首选存储引擎，包括 MySQL、Apache Kafka 和 CockroachDB。

由于 Rockset 采用云原生自动扩展架构，索引管理和集群配置是自动化的。这显著减少了配置容量或管理服务器的运营开销。

数据在 RocksDB 中压缩和索引后的大小是用于使用跟踪和计费的值。

## 存储大小理解

### 融合索引的存储

Rockset 中数据的总大小由 Rockset 在数据之上构建的索引的累积大小决定。Rockset 的融合索引（Converged Indexing）技术为每个文档建立索引，并将索引作为一组键值对存储在 RocksDB 存储引擎中。这种格式针对快速查询服务进行了优化。

融合索引过程会为文档的每个字段建立索引，包括嵌套对象和数组条目。每个字段至少通过三种方式建立索引：

1. **倒排索引（Inverted Index）**：适用于点查询
2. **列式索引（Columnar Index）**：适用于聚合操作
3. **行索引（Row Index）**：适用于数据检索
4. **范围索引**：适用于选择性较低的范围扫描

用户还可以通过配置 Rockset 的摄取转换（Ingest Transformation）创建专门的地理索引（geo-indexes）。

## 数据压缩和存储优化

尽管每个文档字段值存储在多个索引中，但实际存储大小并不会像预期那样显著增加。这是因为 RocksDB 采用了多种压缩和优化技术：

1. **BlockBasedTableFormat**：RocksDB 将一组键值对存储在 BlockBasedTableFormat 中，并在存储到磁盘前进行压缩。

2. **差异化压缩技术**：RocksDB 允许对数据的不同部分使用不同的压缩技术：
   - 频繁使用的数据可以使用 lz4 压缩
   - 不常用的数据可以使用 zstd 或 gzip 压缩

3. **增量编码（Delta-encoding）**：对于具有共同前缀的键，不会重复存储这些前缀，从而减少存储开销。

4. **布隆过滤器（Bloom-filters）**：RocksDB 支持在键的前缀上使用布隆过滤器，而不是为每个键存储一个布隆过滤器。

5. **倒排索引优化**：倒排索引组织为发布列表的键值对，Rockset 使用前缀压缩和 Elias-Fano 编码来减小这些列表的大小。

6. **列式索引优化**：列式索引被分成组，每组按排序顺序存储单个字段的值。这种列式分组通过使用值的增量编码减少存储大小。

## 存储特性

1. **稀疏字段支持**：Rockset 设计为支持稀疏字段，不会产生存储大小放大。在其他数据库系统中，对具有数百个稀疏字段的数据集建立索引可能会增加数据库的总大小，因为这些索引必须记录有关每个字段的一些元数据，即使许多字段在特定记录上不存在。Rockset 的数据格式设计为对这些稀疏字段不产生任何字节开销。

2. **数据生命周期管理**：如果需要减少数据集大小，可以为数据设置保留期限（retention duration）。超出保留窗口的数据会自动删除。

3. **摄取转换优化**：可以使用摄取转换（Ingest Transformations）来过滤存储在 Rockset 中的条目数量和字段数量。可以：
   - 删除特定字段不被索引
   - 仅提取每个条目中的必要信息
   - 完全省略不符合特定条件的条目
   - 将数据聚合到单个条目以避免不必要的存储成本

4. **数据备份机制**：Rockset 中的所有数据都会实时持续备份到 S3。Rockset 消除了用户手动管理存储容量和备份计划的需求。所有数据都存储在 S3 中，因此对于 Rockset 中的所有数据，我们获得了 S3 的 99.999999999% 的持久性。
