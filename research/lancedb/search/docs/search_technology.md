# LanceDB 检索（Search）查询技术及索引结构

## 向量搜索概述

LanceDB 的核心功能是向量搜索，这是一种用于基于向量表示（称为嵌入）搜索相似项的技术。它也被称为相似性搜索、最近邻搜索或近似最近邻搜索。

原始数据（如文本、图像、音频等）通过嵌入模型转换为嵌入向量，然后存储在 LanceDB 等向量数据库中。为了在大规模数据上执行相似性搜索，LanceDB 在存储的嵌入向量上创建索引，从而能够执行快速查找。

## 嵌入向量

现代机器学习模型可以训练为将原始数据转换为嵌入向量，这些向量表示为固定维度的浮点数数组。嵌入向量在实践中之所以有用，是因为嵌入向量在向量空间中的位置捕获了数据的某些语义，具体取决于模型类型和训练方式。

在向量空间中彼此接近的点被认为是相似的（或出现在相似的上下文中），而相距较远的点被认为是不相似的。大型多模态数据集（文本、音频、图像等）可以通过适当的模型转换为嵌入向量。

## 索引技术

LanceDB 使用多种索引技术来优化向量搜索：

### 1. IVF-PQ 索引

LanceDB 的一个关键特性是使用基于磁盘的索引：IVF-PQ，这是倒排文件索引（IVF）的一个变体，使用乘积量化（PQ）来压缩嵌入向量。

IVF-PQ 索引的工作原理：

1. **倒排文件（IVF）**：将向量空间划分为多个聚类，每个聚类由一个中心点表示。查询时，只需搜索与查询向量最接近的几个聚类，而不是整个数据集。

2. **乘积量化（PQ）**：将高维向量分解为多个低维子向量，然后对每个子向量进行量化。这大大减少了存储需求，同时保持了向量之间的相似性关系。

### 2. HNSW 索引

LanceDB 还支持分层可导航小世界（HNSW）索引，这是一种基于图的索引结构，特别适合高维向量的近似最近邻搜索。

HNSW 索引的工作原理：

1. **多层图结构**：HNSW 构建一个多层图，其中顶层包含少量节点，底层包含所有节点。

2. **导航机制**：搜索从顶层开始，然后逐层向下导航，在每一层找到最接近查询点的节点。

3. **高效性**：HNSW 提供对数级的搜索复杂度，使其非常适合大规模数据集。

## IVF-PQ 索引详解

IVF-PQ 是一种复合索引，结合了倒排文件索引（IVF）和乘积量化（PQ）。LanceDB 的实现提供了多个参数来微调索引的大小、查询吞吐量、延迟和召回率。

### 乘积量化（Product Quantization）

量化是一种压缩技术，用于减少嵌入向量的维度以加速搜索。乘积量化（PQ）通过将大型高维向量划分为大小相等的子向量来工作。每个子向量被分配一个"再现值"，映射到该子向量的点的最近质心。然后，这些再现值使用唯一 ID 分配给码本，可用于重建原始向量。

重要的是要记住，量化是一个有损过程，即重建的向量与原始向量不完全相同。这导致索引大小和搜索结果准确性之间的权衡。

例如，考虑从一个由 32 位浮点数组成的 128 维向量开始。将其量化为具有 4 个维度的 8 位整数向量，可以显著减少内存需求：

- 原始：128 × 32 = 4096 位
- 量化后：4 × 8 = 32 位

量化导致索引中每个向量的内存需求减少了 128 倍，这是相当可观的。

### 倒排文件索引（Inverted File Index）

虽然 PQ 有助于减小索引的大小，但 IVF 主要解决搜索性能问题。倒排文件索引的主要目的是通过缩小搜索空间来促进快速有效的最近邻搜索。

在 IVF 中，PQ 向量空间被划分为 Voronoi 单元，这些单元本质上是由空间中所有在给定区域种子点的阈值距离内的点组成的分区。这些种子点通过对存储的向量运行 K-means 来初始化。K-means 的质心变成种子点，然后每个种子点定义一个区域。这些区域用于创建一个倒排索引，将每个质心与空间中的向量列表相关联，允许搜索仅限于索引中的向量子集。

在查询时，根据查询在向量空间中的位置，它可能接近多个 Voronoi 单元的边界，这可能使 top-k 结果变得模糊并跨越多个单元。为了解决这个问题，IVF-PQ 引入了 `nprobe` 参数，它控制在查询期间要搜索的 Voronoi 单元的数量。`nprobe` 越高，结果越准确，但查询越慢。

### 索引构建和查询

在 LanceDB 中构建 IVF-PQ 索引时，有三个关键参数需要设置：

1. **metric**：使用 `L2`（欧几里得距离）度量。LanceDB 还支持 `dot`（点积）和 `cosine`（余弦相似度）距离。

2. **num_partitions**：IVF 部分的分区数量。通常根据每个分区的目标向量数量来选择。

3. **num_sub_vectors**：在乘积量化（PQ）期间将创建的子向量数量。通常根据所需的召回率和向量的维度来选择。

在查询 IVF-PQ 索引时，可以使用以下参数：

1. **limit**：要返回的结果数量。

2. **nprobes**：探测数量决定了向量空间的分布。较高的数字会提高搜索准确性，但也会导致性能变慢。通常，将 `nprobes` 设置为覆盖数据集的 5-10% 可以有效地实现高召回率和最小延迟。

3. **refine_factor**：通过读取额外的元素并在内存中重新排序来优化结果。较高的数字使搜索更准确但也更慢。
